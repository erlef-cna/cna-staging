on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/osv_sync.yml'
      - 'records/**/*.json'
      - '!records/reservations/*.json'
      - 'osv/*.json'
      - 'scripts/cve-to-osv'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

name: "OSV Auto Sync"

permissions:
  contents: read

jobs:
  auto_update:
    name: "Auto-Update OSV Files for Main Branch"
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Login for auto updates
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: app-token
        with:
          app-id: ${{ vars.CNA_BOT_APP_ID }}
          private-key: ${{ secrets.CNA_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ steps.app-token.outputs.token }}
      - name: Install Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          elixir-version: '1.18.4'
          otp-version: '27.3.4.1'
      - name: Find changed CVE files in push
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47.0.0
        id: changed-files
        with:
          files: |
            records/**/*.json
          files_ignore: |
            records/reservations/*.json
      - name: Check if conversion script changed
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47.0.0
        id: script-changed
        with:
          files: |
            scripts/cve-to-osv
            .github/workflows/osv_sync.yml
      - name: Convert changed CVE files to OSV format
        if: steps.changed-files.outputs.any_changed == 'true' && steps.script-changed.outputs.any_changed == 'false'
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "Converting changed CVE files to OSV format..."

          # Convert space-separated files into array and pass all at once
          files_array=($CHANGED_FILES)
          if [ ${#files_array[@]} -gt 0 ]; then
            echo "Converting ${#files_array[@]} files: ${files_array[*]}"
            ./scripts/cve-to-osv convert "${files_array[@]}" || {
              echo "Warning: Failed to convert files, stopping..."
              exit 1
            }
          fi
      - name: Convert all CVE files to OSV format (script changed)
        if: steps.script-changed.outputs.any_changed == 'true'
        run: |
          echo "Conversion script changed, regenerating all OSV files..."

          find records -name "*.json" -not -path "records/reservations/*" | while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "Converting: $file"
              ./scripts/cve-to-osv convert "$file" || {
                echo "Warning: Failed to convert $file, stopping..."
                exit 1
              }
            fi
          done
      - name: Check if OSV files were modified
        id: osv-changes
        run: |
          # Add new files to staging to detect them in diff
          git add osv/

          if git diff --quiet --cached osv/ && git diff --quiet osv/; then
            echo "No OSV changes detected"
            echo "osv_changed=false" >> $GITHUB_OUTPUT
          else
            echo "OSV files were modified or added"
            echo "osv_changed=true" >> $GITHUB_OUTPUT
            # Show what changed
            git diff --stat --cached osv/
            git diff --stat osv/
          fi
      - name: Create or update PR
        if: steps.osv-changes.outputs.osv_changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: "Update OSV files for CVE changes"
          title: "Update OSV files for CVE changes"
          body: |
            This PR updates OSV files following changes to CVE records or the conversion script.

            This automated update converts CVE records to OSV format to keep OSV files synchronized with the latest CVE data.

            Changes in this PR:
            - Updated OSV files to reflect the latest CVE record changes
          labels: automated, osv-update
          branch: osv-cve-updates
          delete-branch: true
          base: main

  update_versions:
    name: "Update OSV Affected Versions"
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Login for version updates
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: osv-app-token
        with:
          app-id: ${{ vars.CNA_BOT_APP_ID }}
          private-key: ${{ secrets.CNA_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ steps.osv-app-token.outputs.token }}

      - name: Install Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          elixir-version: '1.18.4'
          otp-version: '27.3.4.1'

      - name: Update OSV versions
        run: './scripts/cve-to-osv update-versions'

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet osv/; then
            echo "No changes detected"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in OSV files"
            echo "changes=true" >> $GITHUB_OUTPUT
            # Show what changed
            git diff --stat osv/
          fi

      - name: Create or update PR
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.osv-app-token.outputs.token }}
          commit-message: "chore(osv): update affected package versions"
          title: "Update OSV affected package versions"
          body: |
            This PR updates the affected versions in OSV files based on the latest package versions from hex.pm.

            This is an automated update that runs daily to ensure OSV files contain all affected versions.

            Changes in this PR:
            - Updated `versions` arrays in OSV files with newly published hex packages that are affected by the vulnerabilities
          labels: automated, osv-update
          branch: osv-version-updates
          delete-branch: true
          base: main