on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/osv_sync.yml'
      - 'records/**/*.json'
      - '!records/reservations/*.json'
      - 'osv/*.json'
      - 'scripts/cve-to-osv'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

name: "OSV Auto Sync"

permissions:
  contents: read

jobs:
  auto_update:
    name: "Auto-Update OSV Files for Main Branch"
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Login for auto updates
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ vars.CNA_BOT_APP_ID }}
          private-key: ${{ secrets.CNA_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ steps.app-token.outputs.token }}
      - name: Install Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          elixir-version: '1.18.4'
          otp-version: '27.3.4.1'
      - name: Convert all CVE files to OSV format
        run: './scripts/cve-to-osv convert-all'
      - name: Create or update PR
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: "Update OSV files for CVE changes"
          title: "Update OSV files for CVE changes"
          body: |
            This PR updates OSV files following changes to CVE records or the conversion script.

            This automated update converts CVE records to OSV format to keep OSV files synchronized with the latest CVE data.

            Changes in this PR:
            - Updated OSV files to reflect the latest CVE record changes
          labels: automated, osv-update
          branch: osv-cve-updates
          delete-branch: true
          base: main

  update_versions:
    name: "Update OSV Affected Versions"
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Login for version updates
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: osv-app-token
        with:
          app-id: ${{ vars.CNA_BOT_APP_ID }}
          private-key: ${{ secrets.CNA_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ steps.osv-app-token.outputs.token }}

      - name: Install Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          elixir-version: '1.18.4'
          otp-version: '27.3.4.1'

      - name: Update OSV versions
        run: './scripts/cve-to-osv update-versions'

      - name: Create or update PR
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ steps.osv-app-token.outputs.token }}
          commit-message: "chore(osv): update affected package versions"
          title: "Update OSV affected package versions"
          body: |
            This PR updates the affected versions in OSV files based on the latest package versions from hex.pm.

            This is an automated update that runs daily to ensure OSV files contain all affected versions.

            Changes in this PR:
            - Updated `versions` arrays in OSV files with newly published hex packages that are affected by the vulnerabilities
          labels: automated, osv-update
          branch: osv-version-updates
          delete-branch: true
          base: main